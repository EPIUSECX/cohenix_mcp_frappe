# Model Context Profile: Stock

## 1. Module Overview

The `stock` module is the heart of inventory management in ERPNext. It provides a comprehensive suite of tools for tracking the quantity and value of items across multiple warehouses. The module is responsible for managing all inventory-related master data, processing all stock movements, and maintaining an accurate, perpetual inventory ledger.

Its functionality is deeply integrated with the Sales, Buying, and Manufacturing modules, as nearly every transaction in these modules has a stock impact.

## 2. Key Reusable Functions

This section details important client-side and server-side functions that can be leveraged for custom application development.

### 2.1. Server-Side (Python)

#### `erpnext.stock.doctype.stock_entry.stock_entry.StockEntry`

-   **`on_submit()`**: This is the core method for all internal inventory movements. It updates the stock ledger, makes the necessary accounting entries (`GL Entry`), and updates the status of linked documents like `Work Orders` or `Subcontracting Orders`.
-   **`update_stock_ledger()`**: This instance method is called by `on_submit`. It creates the `Stock Ledger Entry` records for the transaction, which is the fundamental operation for any stock movement.
-   **`make_gl_entries()`**: This method generates the accounting entries for the stock transaction, debiting and crediting the appropriate stock and expense accounts based on the `Stock Entry`'s purpose.
-   **`get_items()`**: A whitelisted function that populates the items table in a `Stock Entry` based on a `BOM` or `Work Order`. This is the primary function for creating manufacturing entries.

#### `erpnext.stock.doctype.delivery_note.delivery_note.DeliveryNote`

-   **`on_submit()`**: This method is triggered when a delivery is confirmed. It updates the stock ledger to reduce stock levels, updates the `delivered_qty` and status of the linked `Sales Order`, and makes the necessary accounting entries.
-   **`make_sales_invoice(source_name, ...)`**: A whitelisted function that creates a `Sales Invoice` from a `Delivery Note`. This is a key step in the sales cycle, allowing for billing after delivery.
-   **`make_sales_return(source_name, ...)`**: A whitelisted function that creates a return `Delivery Note` (credit note) from an existing one, reversing the stock and accounting entries.

### 2.2. Client-Side (JavaScript)

#### `erpnext.stock.StockEntry` (Controller)

-   **`get_items()`**: This client-side function is triggered by the user to fetch items. It calls the server-side `get_items` method and populates the items grid, providing a seamless way to create manufacturing entries from a `BOM` or `Work Order`.
-   **`refresh()`**: This method dynamically adds the "Get Items From" buttons (e.g., "Material Request", "Purchase Invoice") based on the document's state, guiding the user through the creation process.

#### `erpnext.stock.DeliveryNoteController`

-   **`refresh()`**: This is the main UI controller for the Delivery Note form. It adds the "Create" buttons ("Sales Invoice", "Sales Return", "Shipment") based on the document's status, providing the user with the next logical actions.
-   **`make_sales_invoice()`**: This function calls the server-side `make_sales_invoice` method via `frappe.model.open_mapped_doc`, which handles the creation of the invoice and routing the user to the new document.
-   **`make_sales_return()`**: This function calls the server-side `make_sales_return` method to create a credit note.

## 3. Data Flow and Architecture

1.  **Master Data**: **`Item`** and **`Warehouse`** masters are created in the `setup` and `stock` modules.
2.  **Transactions**: When a stock-related transaction occurs (e.g., a `Delivery Note` is submitted, a `Purchase Receipt` is received, or a `Stock Entry` is made), the system creates one or more **`Stock Ledger Entry`** records.
3.  **Ledger Posting**: For each item and warehouse in the transaction, an SLE is created.
    -   For an outgoing transaction, `actual_qty` is negative. The `valuation_rate` is determined by the chosen valuation method (FIFO or Moving Average).
    -   For an incoming transaction, `actual_qty` is positive. The `valuation_rate` is based on the purchase price or manufacturing cost.
4.  **Bin Update**: The system updates the `Bin` record (a cache of the current stock level) for the item and warehouse, reflecting the new `qty_after_transaction` from the SLE.
5.  **Reporting**: All stock reports, such as the `Stock Balance` and `Stock Ledger`, are generated by querying the `Stock Ledger Entry` table.

## 4. Architectural Significance

The `stock` module's architecture is centered around the principle of a perpetual, immutable ledger (`Stock Ledger Entry`). This design ensures a high degree of data integrity and provides a complete audit trail for every stock movement. It is a classic example of event sourcing, where the current state (the stock balance in a `Bin`) is derived from a sequence of historical events (the `Stock Ledger Entries`).

This robust and auditable foundation allows ERPNext to provide accurate, real-time inventory valuation and quantity tracking, which is essential for the effective management of a business's supply chain and finances. The clear separation between transactional documents (`Stock Entry`, `Delivery Note`) and the ledger (`Stock Ledger Entry`) is a key architectural pattern that ensures consistency and reliability.