# Model Context Profile: `contacts`

## 1. Module Overview

The `contacts` module provides the core functionality for managing contacts and addresses within the Frappe Framework. It is a fundamental part of any ERP system, linking people and locations to various transactions and master data.

Key functionalities are expected to include:
-   The `Contact` DocType for storing personal and professional contact information.
-   The `Address` DocType for managing shipping, billing, and other types of addresses.
-   Logic for linking contacts and addresses to other documents like `Customer`, `Supplier`, and `User`.
-   APIs and utilities for managing and querying contact information.

## 2. File Index

-   **`address_and_contact.py`**: Contains shared business logic for both `Address` and `Contact` DocTypes, including permission handling, data loading, and utility functions.
-   **`doctype/`**
    -   **`address/`**: Contains the `Address` DocType definition and controller (`address.py`).
    -   **`contact/`**: Contains the `Contact` DocType definition and controller (`contact.py`).
    -   **`address_template/`**: A DocType for defining Jinja templates for formatting addresses based on country.
    -   **`gender/`**: A simple DocType for storing Gender options.
    -   **`salutation/`**: A simple DocType for storing Salutation options (e.g., Mr, Ms, Dr).

## 3. Public API / Callable Functions

-   **`frappe.contacts.address_and_contact.load_address_and_contact(doc)`**: A helper function used in `__onload` of other documents (like Customer, Supplier) to fetch and display the linked addresses and contacts in the UI.
-   **`frappe.contacts.address_and_contact.delete_contact_and_address(doctype, docname)`**: A cleanup utility that deletes related contacts and addresses when a linked document (e.g., a Customer) is deleted.
-   **`frappe.contacts.doctype.address.get_default_address(doctype, name)`**: Retrieves the default primary or shipping address for a given document.
-   **`frappe.contacts.doctype.address.get_address_display(address_dict)`**: Renders an address dictionary into a formatted string using the appropriate `Address Template`.
-   **`frappe.contacts.doctype.contact.get_default_contact(doctype, name)`**: Retrieves the default contact for a given document.
-   **`frappe.contacts.doctype.contact.download_vcard(contact)`**: Generates and serves a VCF (vCard) file for a given contact.

## 4. Detailed Walkthrough

### `address_and_contact.py`

This file provides the shared logic that governs how `Address` and `Contact` documents behave, especially concerning permissions and their relationship with other documents.

-   **Permission Handling**: The functions `has_permission`, `get_permission_query_conditions_for_contact`, and `get_permission_query_conditions_for_address` are crucial. They implement a special permission model for contacts and addresses. A user can see a contact or address if they have permission to see *at least one* of the documents it is linked to (e.g., a Customer or a Supplier). This prevents users from seeing contacts of customers they don't have access to.
-   **`load_address_and_contact(doc)`**: This is a UI helper function. It's called from the `onload` event of documents like Customer and Supplier to fetch the lists of associated addresses and contacts, which are then rendered in the dashboard.
-   **`delete_contact_and_address(doctype, docname)`**: This is a cleanup hook. When a document (like a Customer) is deleted, this function finds all the contacts and addresses linked *only* to that customer and deletes them, ensuring no orphaned data remains.

### `doctype/address/address.py`

This file contains the controller for the `Address` DocType.

-   **`autoname`**: The address name is automatically generated by combining the `address_title` (which defaults to the linked document's name) and the `address_type` (e.g., "Customer A-Billing").
-   **`validate`**: This method orchestrates several validation steps:
    -   It calls `link_address` to automatically create a link to a Contact if the address is being created by a user who is also a contact.
    -   `validate_preferred_address` ensures that for any linked document (like a Customer), there can be only one "Primary" address and one "Shipping" address. If a new address is marked as primary, the old one is automatically unmarked.
-   **`get_address_display(address_dict)`**: This is the core formatting function. It fetches the correct `Address Template` based on the address's country (or the default template if none is found) and uses Jinja to render the address fields into a human-readable block of text.

### `doctype/contact/contact.py`

This file contains the controller for the `Contact` DocType.

-   **`autoname`**: The contact's name is generated from their full name, and if a link exists, the linked document's name is appended to ensure uniqueness (e.g., "John Doe-Customer A").
-   **`validate`**:
    -   It ensures the `full_name` field is always up-to-date by combining first, middle, and last names.
    -   It calls `set_primary_email` and `set_primary` to manage the primary email and phone numbers. A contact can have multiple emails and phone numbers (in child tables), but only one of each can be marked as primary. The primary values are copied to the main fields on the Contact document (`email_id`, `phone`, `mobile_no`) for easy access.
    -   It automatically fetches and sets the contact's Gravatar as their profile image if one exists for their email.
-   **`get_vcard()`**: This method constructs a `vCard` object (using the `vobject` library), populating it with the contact's name, title, organization, emails, and phone numbers. This object is then used by the `download_vcard` function to generate a downloadable `.vcf` file.
-   **`invite_user(contact)`**: A utility function that creates a new `User` document of type "Website User" from a contact's details and sends them a welcome email, effectively inviting them to the system.